## Django Migrations Under the Hood

### By laixintao

---

## å…³äºæˆ‘


- ã€Šæ•è›‡è€…è¯´ã€‹FM(@laike9m @Manjusaka @Adam)
- ã€ŠPythonå¹¶è¡Œç¼–ç¨‹ã€‹ç¿»è¯‘ï¼ˆè¿˜æ²¡å®Œæˆï¼‰
- pingtop, git-ext, iredis, etc.
- ä»2016å¹´å¼€å§‹å†™ Python (Django1.8)

![auto-complete](assets/auto-complete.png)

+++

## ç¬¬ä¸€ä¸ª Django é¡¹ç›®

- ä¸€ä¸ªäººå®Œæˆå¼€å‘ã€éƒ¨ç½²ã€å‰åç«¯ï¼›
- åŒ…æ‹¬æ³¨å†Œç™»å½•ã€æ´»åŠ¨å‘å¸ƒã€æŠ¥åä»˜æ¬¾ï¼Œé€šçŸ¥ï¼›
- ä»åœ¨çº¿ä¸Šè¿è¡Œï¼ˆ3å¹´ï¼‰ï¼›

+++

## ä½†æ˜¯...
### å…¶å®æˆ‘ä¸ä¼šSQL...

+++

- `python manage.py makemigrations` & `python manage.py migrate` for DDL
- `python manage.py shell` for query and DML

+++

## è¿™å°±æ˜¯ Django ï¼

> The web framework for perfectionists with deadlines.

---?color=#ffcfdf

## Table of Contents

- ğŸ‘‰ Django Migraiton çš„åŠŸèƒ½
- å·¥ä½œåŸç†
- ç”¨æ³•å’Œå¸¸è§é—®é¢˜
- Django çš„é€‰æ‹©

+++

## Migration æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ

1. Django è´Ÿè´£ CURD
2. æ•°æ®å­˜å‚¨åœ¨ MySQLï¼ˆæˆ–è€…å…¶ä»–SQLæ•°æ®åº“ä¸­ï¼‰
3. Django ORM è´Ÿè´£æ•°æ®åº“çš„ Table å’Œ Python Class å¯¹åº”
4. Migrations å°±æ˜¯æ•°æ®åº“ç»“æ„çš„ Version Control Systemï¼

+++

![](./assets/django-migrations-ppt/django-migrations-usage.png)

```python
class Person(models.Model):
    name = models.CharField(max_length=64)
    age = models.IntegerField()
```

æ˜ å°„åˆ°...

```SQL
mysql root@localhost:django_example> describe app1_person;
+-------+-------------+------+-----+---------+----------------+
| Field | Type        | Null | Key | Default | Extra          |
+-------+-------------+------+-----+---------+----------------+
| id    | int(11)     | NO   | PRI | <null>  | auto_increment |
| name  | varchar(64) | NO   |     | <null>  |                |
+-------+-------------+------+-----+---------+----------------+
```

+++

### ä¸ºä»€ä¹ˆéœ€è¦ migrationsï¼Ÿ

- å¦‚æœæ²¡æœ‰æ•°æ®åº“ç»“æ„è¿ç§»æœºåˆ¶çš„è¯ï¼Œéœ€è¦æ‰‹åŠ¨åœ¨ä»£ç å’Œè¡¨ç»“æ„ä¹‹é—´åŒæ­¥ï¼›
- å›¢é˜Ÿåä½œä¼šå¾ˆæ··ä¹±ï¼›
- å¤šä¸ªç¯å¢ƒéƒ¨ç½²ä¼šå¾ˆæ··ä¹±ï¼›
- æ‰‹åŠ¨å˜æ›´éš¾ä»¥è¿½è¸ªï¼›

+++

### Django migrations å¸®åŠ©ä½ 

- è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„è¡¨ç»“æ„ï¼›
- è®°å½•æ¯ä¸€æ¬¡å˜æ›´ï¼Œå†…ç½®çš„å›æ»šæ–¹æ¡ˆï¼›
- â€œå£°æ˜å¼â€ï¼Œå¯ä»¥è¢«é‡å¤æ‰§è¡Œï¼Œç»“æœå¹‚ç­‰ï¼ˆè¿™æ„å‘³ç€è§£å†³äº†å¤šç¯å¢ƒçš„é—®é¢˜ï¼‰ï¼›

---?color=#ffcfdf

## Table of Contents

- Django Migraiton çš„åŠŸèƒ½
- ğŸ‘‰ å·¥ä½œåŸç†
- ç”¨æ³•å’Œå¸¸è§é—®é¢˜
- Django çš„é€‰æ‹©

+++

### Django migrations æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

1. è‡ªåŠ¨ç”Ÿæˆæ¯ä¸€æ¬¡çš„æ•°æ®åº“å˜æ›´ï¼›
2. æ‰§è¡Œæ•°æ®åº“å˜æ›´ï¼›

+++

### é‡å¤æ‰§è¡Œæ²¡æœ‰å‰¯ä½œç”¨

```
$ python manage.py makemigrations
No changes detected
```

+++?color=#ffffff

## ç”Ÿæˆå˜æ›´

```
$ python manage.py makemigrations
```

![](./assets/django-migrations-ppt/django-orm.png)

+++

### æ­¥éª¤

1. åº”ç”¨å†å²çš„å˜æ›´ï¼Œå¾—åˆ°ä¸Šæ¬¡æœ€æ–°çš„ç»“æ„ Aï¼›
2. å¯¹æ¯”å½“å‰çš„ Model Bï¼›
3. ç”Ÿæˆä» A çŠ¶æ€è¿ç§»åˆ° B çŠ¶æ€çš„å˜æ›´;

+++

- è¿™æ­¥ä¸éœ€è¦è¿æ¥æ•°æ®åº“ï¼›
- O(n) æ“ä½œï¼Œå¦‚æœå†å²çš„ migrations å¾ˆå¤šäº†ï¼Œè€—æ—¶ä¼šå¾ˆé•¿ï¼›
- ä¸èƒ½æœ‰æ­§ä¹‰;

+++

æŠŠè¿™ä¸ªè¿‡ç¨‹æƒ³è±¡æˆä¸Šå¸åœ¨çœ‹ç€ä½ ä¸‹æ£‹ã€‚

ä½†æ˜¯ä»–ä¸ä¼šè®°ä½æ¯ä¸€æ­¥ï¼Œ

æ¯å½“ä½  makemigrations çš„æ—¶å€™ï¼Œ

ä»–ä¼šè®°ä¸‹æ¥æ€ä¹ˆæŠŠä¸Šæ¬¡çš„æ£‹ç›˜å˜æˆç°åœ¨çš„æ ·å­ã€‚

![](./assets/django-migrations-ppt/chess.png)

+++

### æ­§ä¹‰

![](./assets/django-migrations-ppt/fields.png)

+++

a -> b ?

a -> c ?

```
Did you rename person.inta to person.intc (a IntegerField)? [y/N] N
Did you rename person.intb to person.intc (a IntegerField)? [y/N] y
Did you rename person.inta to person.intd (a IntegerField)? [y/N] N
```

+++

## æ‰§è¡Œå˜æ›´

```
$ python manage.py migrate
```

+++

### é‡å¤æ‰§è¡Œä¸ä¼šå¸¦æ¥å‰¯ä½œç”¨

```
$ python manage.py migrate
Running migrations:
  No migrations to apply.
```

+++

### migrate åšäº†ä»€ä¹ˆï¼Ÿ

- çœŸæ­£å¼•èµ·æ•°æ®åº“ç»“æ„æ”¹å˜çš„æ“ä½œï¼›
- å°† migration files ç¿»è¯‘æˆ SQL å¹¶æ‰§è¡Œï¼›

```Python
  File: app1/migrations/0006_auto_20190912_1150.py
  # Generated by Django 2.2.5 on 2019-09-12 11:50

  from django.db import migrations, models


  class Migration(migrations.Migration):

      dependencies = [
          ('app1', '0005_auto_20190912_1149'),
      ]

      operations = [
          migrations.RenameField(
              model_name='person',
              old_name='intb',
              new_name='intc',
          ),
          migrations.RemoveField(
              model_name='person',
              name='inta',
          ),
          migrations.AddField(
              model_name='person',
              name='intd',
              field=models.IntegerField(default=None),
              preserve_default=False,
          ),
      ]
```

+++

### å¦‚ä½•é˜²æ­¢ SQL é‡å¤æ‰§è¡Œï¼Ÿ

```SQL
mysql root@localhost:django_example> SELECT * FROM django_migrations LIMIT 3;
+----+--------------+--------------+----------------------------+
| id | app          | name         | applied                    |
+----+--------------+--------------+----------------------------+
| 1  | contenttypes | 0001_initial | 2019-09-08 09:08:51.254479 |
| 2  | auth         | 0001_initial | 2019-09-08 09:08:51.355292 |
| 3  | admin        | 0001_initial | 2019-09-08 09:08:51.544356 |
+----+--------------+--------------+----------------------------+
```

+++

### æ€»ç»“

1. Django ç”¨ä¹‹å‰çš„ migrations æ–‡ä»¶ä½œä¸ºä¸Šä¸€ä¸ªçŠ¶æ€çš„ source of truthï¼Œå’Œå½“å‰
çŠ¶æ€ä½œå¯¹æ¯”ï¼Œå¾—åˆ° diff ç”Ÿæˆæ–°çš„ migrationsï¼›
2. Django åœ¨æ•°æ®åº“ä¸­ç”¨ä¸€å¼ è¡¨è®°å½•å“ªäº› migrations è¢«æ‰§è¡Œè¿‡äº†ï¼Œé˜²æ­¢é‡å¤æ‰§è¡Œï¼›

---?color=#ffcfdf

## Table of Contents

- Django Migraiton çš„åŠŸèƒ½
- å·¥ä½œåŸç†
- ğŸ‘‰ ç”¨æ³•å’Œå¸¸è§é—®é¢˜
- Django çš„é€‰æ‹©

+++

## FAQ1

> å°† migrate åŠ å…¥åˆ°å¯åŠ¨å‘½ä»¤ä¸­?

æ—¢ç„¶ migrate æ˜¯å¹‚ç­‰çš„ï¼Œæˆ‘æŠŠè¿™ä¸ªæ“ä½œæ”¾åˆ° Docker çš„ CMD
ä¸­ï¼Œæ¯æ¬¡å¯åŠ¨ä¹‹å‰è‡ªåŠ¨åº”ç”¨æ–°çš„å˜æ›´ï¼ˆå¦‚æœæœ‰ï¼‰.

What cloud go wrong?

+++

# DON'T DO THAT!

+++

# Why?

1. å¤šå°æœºå™¨åŒæ—¶å¯åŠ¨å¯èƒ½æŸåè¡¨ç»“æ„ï¼›
2. é»˜è®¤å½“å‰çš„æ•°æ®ç»“æ„åªä¼šè¢«å½“å‰çš„ä»£ç ä½¿ç”¨ï¼›
(ç°åº¦ï¼Ÿå›æ»šï¼Ÿéƒ½ä¸å¯è¡Œäº†ï¼‰

+++

## æœ€ä½³å®è·µ

1. ç”¨ä¸€ä¸ªå•ç‹¬çš„ Docker image æ¥åš migrateï¼›
2. migrate è¦å‘åå…¼å®¹ï¼ˆè¿™æ˜¯å¦ä¸€ä¸ªæ•…äº‹äº†ï¼‰

+++ 

## FAQ2

> migrate æ‰§è¡Œå¤±è´¥

ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿï¼Ÿ

å› ä¸º `makemigrations` çš„æ—¶å€™å¹¶æ²¡æœ‰è¿æ¥æ•°æ®åº“ï¼Œæ˜¯åŸºäºé€»è¾‘ç”Ÿæˆçš„ã€‚çœŸæ­£æ‰§è¡Œçš„æ—¶å€™å¯èƒ½å¤±è´¥ã€‚

+++

### å¦‚ä½•æ¢å¤ï¼Ÿ

1. å¤åŸå·²ç»æ‰§è¡Œè¿‡çš„æ“ä½œï¼›
2. åˆ é™¤ `django_migrations` è®°å½•ï¼›
3. ä¿®å¤ migrations æ–‡ä»¶ï¼›
4. é‡æ–°æ‰§è¡Œã€‚

+++

## FAQ3

> ä¸ºä»€ä¹ˆæˆ‘æ²¡æœ‰æ”¹åŠ¨ä»»ä½• Modelsï¼Œä½†æ˜¯æ¯æ¬¡ `makemigrations` éƒ½ä¼šç”Ÿæˆæ–°çš„ï¼Ÿ

+++

### è¿˜è®°å¾— migrations æ˜¯æ€ä¹ˆç”Ÿæˆçš„å—ï¼Ÿ

![](./assets/django-migrations-ppt/django-orm.png)

+++

Model å’Œ Migrations ç»“æœå¯¹æ¯”æ¯æ¬¡éƒ½æœ‰ diffï¼š

- ä»£ç ä¸­æ˜¯ä¸æ˜¯ç”¨äº†ç»“æœä¸ç¡®å®šçš„æ•°æ®ç»“æ„ï¼Ÿï¼ˆæ¯”å¦‚ Python3.5 ä¹‹å‰çš„ dictï¼‰
- ä»£ç ä¸­æ˜¯å¦æœ‰ä»£ç æ¯æ¬¡æ‰§è¡Œçš„ç»“æœæ˜¯ä¸ç¡®å®šçš„ï¼Ÿ

+++

## FAQ4

> æˆ‘å’ŒåŒäº‹åœ¨ä¸åŒçš„åˆ†æ”¯ç”Ÿæˆäº† 000N ç›¸åŒçš„ migrations æ€ä¹ˆåŠï¼Ÿ

+++

```python
$ python manage.py makemigrations --merge
```

+++

## FAQ5

> migrations æ‰§è¡Œå¤ªæ…¢äº†

+++

### é‡å»º migrations

> å› ä¸º migrations è®°å½•äº†æ‰€æœ‰çš„å˜æ›´ï¼Œå¦‚æœè¿™äº›å˜æ›´åœ¨ä¸€æ®µæ—¶é—´ä¹‹åå¯¹æˆ‘ä»¬ä¸å†é‡è¦ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå½“å‰çš„ModelçŠ¶æ€ä½œä¸º 0001 ã€‚

+++

### æ­¥éª¤

1. å¤‡ä»½æ•°æ®åº“å’Œæ•´ä¸ªé¡¹ç›®ï¼›
2. `ls */migrations/*.py | grep -v __init__ | xargs rm` åˆ é™¤å†å² migrations
3. é‡æ–° `makemigrations`
4. åˆ é™¤ `django_migrations` è®°å½•ï¼›
5. `python manage.py migrate --fake` å¡«å…… `django_migrations` æ•°æ®ï¼›

+++

## FAQ6

> æ˜¯å¦åº”è¯¥å°†ç”Ÿæˆçš„ migrations æ–‡ä»¶è¿½è¸ªåˆ° git ä¸­ï¼Ÿ

æ˜¯çš„ã€‚

+++

## FAQ7

> ä¸è¦å®³æ€•è‡ªå·±å†™ migrations

+++

å½“ä½ æƒ³ï¼š

1. ä½ çš„ Model å˜åŒ–å¤ªå¤æ‚ï¼Œæƒ³è¦è‡ªå·±å†™ Migrations çš„æ—¶å€™ï¼›
2. åœ¨ migrate ç»“æ„çš„åŒæ—¶ï¼Œæœ‰ä¸€äº›æ•°æ®éœ€è¦å˜åŒ–çš„æ—¶å€™ï¼›

+++

ç”¨ `python manage.py makemigrations --empty` ç”Ÿæˆä¸€ä¸ªç©ºçš„ï¼Œ
ç„¶åè‡ªå·±å†™ã€‚

+++

RunPython & RunSQL are you friends!

```Python

def my_editor(app, schema_editor):
    Person = app.get_model("app1", "Person")
    schema_editor.remove_field(Person, "age")


class Migration(migrations.Migration):

    dependencies = [("app1", "0001_initial")]

    operations = [migrations.RunPython(my_editor)]
```

+++

### å‡ ç‚¹è¦æ³¨æ„çš„äº‹æƒ…

1. `app.get_model`;
2. ä¸è¦åœ¨ RunSQL é‡Œé¢è®°å½•è¡¨ç»“æ„å˜æ›´;

---?color=#ffcfdf

## Table of Contents

- Django Migraiton çš„åŠŸèƒ½
- å·¥ä½œåŸç†
- ç”¨æ³•å’Œå¸¸è§é—®é¢˜
- ğŸ‘‰ Django çš„é€‰æ‹©

+++

Django çš„ migration è®¾è®¡ï¼š

1. migrations è®°å½•æ¯ä¸€æ¬¡å˜æ›´ï¼›
2. æ•°æ®åº“ä¸€å¼ metaè¡¨è®°å½•å˜æ›´çš„æ‰§è¡Œæƒ…å†µï¼›

+++

è¿™æ ·çš„è®¾è®¡ç»™æˆ‘ä»¬ä»€ä¹ˆï¼Ÿ

1. Model çš„ source of truth;
2. å˜æ›´å†å²è®°å½•;
3. ä½†æ˜¯æ²¡æœ‰éšè—æ‰€æœ‰çš„äº‹æƒ…ï¼Œmigrations å¯ä»¥è¢«äººä¸ºå¹²æ¶‰ï¼›

+++

## æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…¶ä»–çš„æ–¹æ¡ˆ

+++

### æ²¡æœ‰ migrations

- ç›´æ¥å¯¹æ¯”ä»£ç ä¸­çš„ Model å’Œæ•°æ®åº“çš„ Table
- æ¶ˆé™¤ diff

### ç¼ºç‚¹

- è¿ç§»è¿‡ç¨‹ä¸é€æ˜ï¼Œä¸å¯æ§åˆ¶

+++

## æœ‰ migrate è¡¨ä½†æ˜¯ä¸è®°å½• migrations

+++

## automigrate

https://github.com/abe-winter/automigrate

+++




## ä¸€äº›åå¯¹ ORM çš„å£°éŸ³

- Defining your schema in your ORM is nuts because it ties you to one language, reduces clarity, and sometimes limits SQL features you can use
- Existing migration tools don't pull their weight
- SQL is a more general skill than ORMs and other tools should therefore mirror SQL
- Mirroring live databases to get a schema is insane because are you tunneling to prod to run your linter? Live DB shouldn't be available to developers. Source of truth should be git.
- Schema should be versioned using the same git shas as code so the logic is easy to detect if a deploy requires a migration

footnote : "<a href='https://github.com/abe-winter/automigrate#philosophy'>automigrate project</a>"

+++

> Exactly this, I tend to write plain SQL nowadays since you eventually have to work around some ORM specific problems in the end. 

https://lobste.rs/s/ihqxej/orms_are_backwards#c_0x76xn


---?color=#fefdca

# Thanks!

- Blog: https://www.kawabangga.com/
- Slide åœ°å€ï¼š https://github.com/laixintao/django-migrations-under-the-hood
